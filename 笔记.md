## 密码学原理：

## 1、Hash

crypto-currency(加密货币)、哈希

哈希碰撞--->   x=y  -> H(x) ≠H(y)

## 2、Hiding

x->H(x)  但是H(x) -\\->x       不可逆            通常x后加一个随机数取hash   H(x||nonce)

x输入空间足够大，分布均匀

digital equipment of a sealed  envelope

## 3、puzzle friendly

H(block header) <= target

##### 比特币的hash函数:

SHA-256  (Secure Hash Algorithm)

##### 比特币开户：公私钥(非对称加密)  

 公钥加密，私钥解密     都是接收方的，公钥给别人，私钥自己留着解密

## 数据结构：

### 哈希指针

哈希链表是根据每个区块合一起取的哈希

![image-20220905195054244](image/image-20220905195054244.png)

如果红色部分的块被改，那么其他的都会改，后面的都会改，所以只需要保存最后一个结点即可知道其他区块是否改变。

![image-20220905195345963](image/image-20220905195345963.png)

如果接受外来区块，如红色的，查看与该节点相连的区块保存的hash值是否和红块一致

### Merkle Tree

![image-20220905200359226](image/image-20220905200359226.png)

绿色的哈希值和红色的哈希值相结合，依次得出向上，所以只需要看根节点的

因为哈希碰撞原理，全节点的篡改几乎不可能

证明包含某个交易的时间复杂度:log(n)

证明不包含的，最快需要排序时间复杂度加log(n)

## 比特币协议

交易示意图

![image-20220905205148724](image/image-20220905205148724.png)

### 块头和块体

![image-20220905205737456](image/image-20220905205737456.png)

#### block header包含的大多为宏观信息

比特币协议

指向前一块的指针

merkle tree的根哈希值

挖矿的目标阈值target

随机数nonce

#### block body

交易列表

### 全结点-轻结点

full node   -----fully validating node     保存所有信息，验证信息

light node -----只保存block header信息

### distributed consensus(分布式共识)

#### FLP impossiblity result    

asynchronous 网络传输过程中，时延没有上线。即使一个成员faulty(有问题)，也不能达成共识。

#### CAP Theorem

CAP------(consistency)  (availablity)  (partition tolerance)一致性   可用性    分区容错性，三者最多可取两个，无法同时满足

### Consensus in Bitcoin

 女巫攻击：产生超过半数的结点进行投票

##### 最长合法链

![image-20220906153158875](image/image-20220906153158875.png)

例如A->A` 插入到该链中，来回滚之前的事物，被称为分叉攻击。

当两个矿工同时产生一个区块(获得记账权)，等长情况会维持一段时间，直到谁先再拓展一个区块为胜出。

根据算力来进行投票

## 比特币实现

### transaction-based ledger

UTXO----Unspent Transaction Output			未花掉的交易

区块链中维护UTXO可以检测双花，快速交易

![image-20220906161059685](image/image-20220906161059685.png)

例如：A给B了5个，B花了，B的输出就不在有UTXO。C不花就在。B输出给了别人，就会产生新的UTXO	

每个交易有多个输入和输出，但是所有的输入金额等于所有的输出金额。

在交易过程中会有交易费，用于奖励初块

### account-based ledger







![image-20220906164509421](image/image-20220906164509421.png)

上图中H计算不包含tx(交易)，只包含块头





![image-20220906194054893](image/image-20220906194054893.png)

挖矿时间与过去挖了多次时间没关系，概率一直是一样的

比特币总量

![image-20220906194623912](image/image-20220906194623912.png)

![image-20220906200534150](image/image-20220906200534150.png)

对于M，如果M给A后，再次发布一个给自己的，造成双花攻击。此时需要M->A后续继续确认，因为大部分的节点都是善良的结点。